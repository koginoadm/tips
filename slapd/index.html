# START ########################################################
cat <<'__COMMENT__'
<link rel="stylesheet" href="/css/vs2015.css"><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><style>body{font-size:0;margin:0}.monospaced{font-size:1rem;font-family:"Osaka－等幅",Consolas,"Courier New",Courier,monospace}</style><div><pre><code class="monospaced"># curl http://djeeno.info/

# Disable SELinux.
grep -q '^SELINUX=enforcing' /etc/selinux/config && sed 's/^\(SELINUX=\)\(enforcing\)/#\1\2\n\1disabled/g' $_ -i_$(date +%Y%m%d_%H%M%S).backup && setenforce 0

# Update packages.
yum makecache fast
yum -y update

# Install OpenLDAP Server.
yum -y install openldap-servers openldap-clients

# Allow LDAP and LDAPS for Firewalld.
if systemctl status firewalld > /dev/null 
then
    firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 1000 -p tcp -m tcp --dport 389 -j ACCEPT
    firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 1000 -p tcp -m tcp --dport 636 -j ACCEPT
    firewall-cmd --reload
fi

# Copy default DB_CONFIG.example.
cp -pi /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG && chown ldap. $_

# Start slapd.
systemctl enable slapd
systemctl start slapd



# Generate RootPW for cn=config.
test -f ~/.slapd.secret || printf $(cat /dev/urandom | tr -dc '[:alnum:]' | head -c 16) > $_
ls -l ~/.slapd.secret && chmod 600 $_ && chown ldap. $_ && ls -l $_

# Set RootPW for cn=config.
ldapmodify -v -Y EXTERNAL -H ldapi:/// <<__EOF__
dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: $(slappasswd -h {CRYPT} -c '$6$%.8s' -T ~/.slapd.secret)
__EOF__

# Confirm RootPW for cn=config.
ldapsearch -v -LLL -x -w $(cat ~/.slapd.secret) -D "cn=config" -b "olcDatabase={0}config,cn=config" "olcRootPW"



# List default prepared schemas.
ls -l /etc/openldap/schema/*.ldif

# Add ppolicy schema.
ldapadd -v -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/ppolicy.ldif

# Confirm that the schemas added.
ldapsearch -v -LLL -Y EXTERNAL -H ldapi:/// -Q -b "cn=schema,cn=config" "dn"



# Set PasswordHash & PasswordCryptSaltFormat
ldapmodify -v -Y EXTERNAL -H ldapi:/// <<'__EOF__'
dn: cn=config
changetype: modify
replace: olcPasswordHash
olcPasswordHash: {CRYPT}

dn: cn=config
changetype: modify
replace: olcPasswordCryptSaltFormat
olcPasswordCryptSaltFormat: $5$%.8s
__EOF__

# Confirm PasswordHash & PasswordCryptSaltFormat
ldapsearch -v -LLL -Y EXTERNAL -H ldapi:/// -Q -b "cn=config" "(cn=config)" "olcPasswordHash" "olcPasswordCryptSaltFormat"



# Set Suffix
_SUFFIX="dc=example,dc=com"
ldapmodify -v -Y EXTERNAL -H ldapi:/// <<__EOF__
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: ${_SUFFIX}
__EOF__

# Generate RootDN & RootPW for Suffix.
_ROOTDN="cn=root,${_SUFFIX}"
test -f ~/.slapd.${_ROOTDN}.secret || printf $(cat /dev/urandom | tr -dc '[:alnum:]' | head -c 16) > $_
ls -l ~/.slapd.${_ROOTDN}.secret && chmod 600 $_ && chown ldap. $_ && ls -l $_

# Set RootDN & RootPW for Suffix.
ldapmodify -v -Y EXTERNAL -H ldapi:/// <<__EOF__
dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: ${_ROOTDN}

dn: olcDatabase={2}hdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: $(slappasswd -h {CRYPT} -c '$6$%.8s' -T ~/.slapd.${_ROOTDN}.secret)
__EOF__

# Confirm & RootDN & RootPW for Suffix.
ldapsearch -v -LLL -Y EXTERNAL -H ldapi:/// -Q -b "olcDatabase={2}hdb,cn=config" "olcSuffix" "olcRootDN" "olcRootPW"



# Set RootDN & 














# written by <a href="https://github.com/koginoadm">@koginoadm</a></code></pre></div>
__COMMENT__
# END ##########################################################
